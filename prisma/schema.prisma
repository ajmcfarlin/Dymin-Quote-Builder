// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String?  // Optional for now
  name      String
  password  String
  role      String   @default("sales") // "admin", "sales"
  isActive  Boolean  @default(true)
  quotes    Quote[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Quote {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  // Quote identification
  quoteNumber   String?   @unique // Auto-generated quote number
  version       Int       @default(1) // For quote versioning
  
  // Customer information
  customerName  String
  customerEmail String?
  customerAddress String?
  customerRegion  String?
  
  // Contract details
  contractType  String?   // 'Managed Services', 'Co-Managed Services'
  contractMonths Int      @default(36)
  
  // Quote data (comprehensive JSON structure)
  customerData  Json      // Full CustomerInfo object
  setupServices Json      // Array of SetupService objects
  monthlyServices Json    // MonthlyServicesData object
  supportDevices Json     // Array of support device configurations
  otherLaborData Json     // OtherLaborData object
  
  // Financial summary
  monthlyTotal    Float   @default(0)
  setupCosts      Float   @default(0)
  upfrontPayment  Float   @default(0)
  contractTotal   Float   @default(0)
  
  // Discount information
  discountType    String? // 'none', 'percentage', 'raw_dollar', 'margin_override', 'per_user', 'override'
  discountValue   Float?  @default(0)
  discountedTotal Float?  @default(0)
  
  // Margins and analysis (for internal use)
  estimatedCost   Float?  @default(0)
  profitMargin    Float?  @default(0)
  
  // External integrations
  haloPsaQuoteId  String? // Reference to HaloPSA quote if generated
  
  // Metadata
  notes           String? // Internal notes
  clientNotes     String? // Notes visible to client
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([customerName])
  @@index([createdAt])
  @@index([userId, createdAt]) // Compound index for user's quotes ordered by date
  @@index([customerName, createdAt]) // For search with date ordering
}

model Configuration {
  id     String @id @default(cuid())
  name   String @unique
  config Json
}

// HaloPSA Sync Models
model HaloTeam {
  id          String      @id @default(cuid())
  haloId      Int         @unique
  name        String
  ticketCount Int         @default(0)
  isActive    Boolean     @default(true)
  agents      HaloAgent[]
  teamCostAnalysis TeamCostAnalysis[]
  syncedAt    DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model HaloAgent {
  id           String    @id @default(cuid())
  haloId       Int       @unique
  name         String
  email        String?
  level        Int       @default(2) // 1=Junior, 2=Intermediate, 3=Senior
  costPerHour  Float     @default(0)
  isActive     Boolean   @default(true)
  departmentId Int?
  teamId       String?
  team         HaloTeam? @relation(fields: [teamId], references: [id])
  rawData      Json      // Store full agent data from HaloPSA
  syncedAt     DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model HaloSyncLog {
  id            String   @id @default(cuid())
  syncType      String   // 'teams', 'agents', 'full'
  status        String   // 'success', 'error', 'partial'
  recordsSync   Int      @default(0)
  errorMessage  String?
  syncData      Json?    // Store summary data
  syncedAt      DateTime @default(now())
}

model TeamCostAnalysis {
  id             String   @id @default(cuid())
  teamId         String
  team           HaloTeam @relation(fields: [teamId], references: [id])
  level1Count    Int      @default(0)
  level1AvgCost  Float    @default(0)
  level2Count    Int      @default(0)
  level2AvgCost  Float    @default(0)
  level3Count    Int      @default(0)
  level3AvgCost  Float    @default(0)
  totalAgents    Int      @default(0)
  analysisDate   DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// HaloPSA Service Hours Models
model HaloService {
  id              String                @id @default(cuid())
  haloId          Int                   @unique
  name            String
  description     String?
  category        String?
  serviceType     String?               // 'setup', 'monthly', 'project'
  isActive        Boolean               @default(true)
  templates       HaloServiceTemplate[]
  items           HaloServiceItem[]
  syncedAt        DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
}

model HaloServiceTemplate {
  id              String      @id @default(cuid())
  haloId          Int         @unique
  name            String
  description     String?
  serviceId       String?
  service         HaloService? @relation(fields: [serviceId], references: [id])
  
  // Hour estimates by skill level
  level1Hours     Float       @default(0)
  level2Hours     Float       @default(0) 
  level3Hours     Float       @default(0)
  totalHours      Float       @default(0)
  
  // Template metadata
  templateType    String?     // 'ticket', 'project', 'workflow'
  priority        Int?
  category        String?
  
  rawData         Json        // Store full template data from HaloPSA
  syncedAt        DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model HaloServiceItem {
  id              String      @id @default(cuid())
  haloId          Int         @unique
  name            String
  description     String?
  serviceId       String?
  service         HaloService? @relation(fields: [serviceId], references: [id])
  
  // Cost and pricing
  costPerUnit     Float       @default(0)
  pricePerUnit    Float       @default(0)
  
  // Time estimates (if applicable)
  setupHours      Float       @default(0)
  maintenanceHours Float      @default(0)
  
  // Item metadata
  itemType        String?     // 'hardware', 'software', 'service'
  vendor          String?
  sku             String?
  
  rawData         Json        // Store full item data from HaloPSA
  syncedAt        DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model ServiceHoursSyncLog {
  id              String   @id @default(cuid())
  syncType        String   // 'templates', 'items', 'full'
  status          String   // 'success', 'error', 'partial'
  recordsSync     Int      @default(0)
  errorMessage    String?
  syncData        Json?    // Store summary data
  syncedAt        DateTime @default(now())
}

// Support Labor Configuration Models
model SupportDevice {
  id                String            @id @default(cuid())
  deviceId          String            @unique  // 'domain-controllers', 'ms-intune-mgmt', etc.
  name              String            // 'Domain Controllers', 'MS InTune Mgmt', etc.
  defaultSkillLevel Int               @default(2) // 1, 2, or 3
  isActive          Boolean           @default(true)
  
  // Predictable maintenance hours
  predictableOnsiteBusiness     Float @default(0)
  predictableRemoteBusiness     Float @default(0)
  predictableOnsiteAfterHours   Float @default(0)
  predictableRemoteAfterHours   Float @default(0)
  
  // Reactive maintenance hours  
  reactiveOnsiteBusiness        Float @default(0)
  reactiveRemoteBusiness        Float @default(0)
  reactiveOnsiteAfterHours      Float @default(0)
  reactiveRemoteAfterHours      Float @default(0)
  
  // Emergency service hours
  emergencyOnsiteBusiness       Float @default(0)
  emergencyRemoteBusiness       Float @default(0)
  emergencyOnsiteAfterHours     Float @default(0)
  emergencyRemoteAfterHours     Float @default(0)
  
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}
